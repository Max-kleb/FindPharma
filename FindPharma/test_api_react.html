<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FindPharma - Test API avec Leaflet</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .search-form {
            display: none;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
            margin-top: 20px;
        }
        
        .search-form.active { display: grid; }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .map-container, .list-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .section-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
        }
        
        #map {
            height: 500px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }
        
        .pharmacy-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .pharmacy-card {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .pharmacy-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }
        
        .pharmacy-card.selected {
            border-color: #667eea;
            background: #f7faff;
        }
        
        .pharmacy-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pharmacy-info {
            color: #4a5568;
            margin: 5px 0;
            font-size: 0.95em;
        }
        
        .distance-badge {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .status-active {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-inactive {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .error {
            background: #fed7d7;
            color: #742a2a;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .info {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .info-title {
            color: white;
            font-weight: 700;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè• FindPharma - Test API</h1>
            <p style="color: #4a5568; font-size: 1.1em;">
                Interface de test avec Leaflet pour l'API Django REST
            </p>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="btn-group">
                <button class="btn btn-primary" onclick="fetchAllPharmacies()">
                    üìã Toutes les pharmacies
                </button>
                <button class="btn btn-secondary" onclick="toggleSearchForm()">
                    üìç Pharmacies proches
                </button>
            </div>

            <!-- Search Form -->
            <div id="searchForm" class="search-form">
                <div class="form-group">
                    <label>Latitude</label>
                    <input type="number" id="latitude" value="3.8480" step="0.0001">
                </div>
                <div class="form-group">
                    <label>Longitude</label>
                    <input type="number" id="longitude" value="11.5021" step="0.0001">
                </div>
                <div class="form-group">
                    <label>Rayon (km)</label>
                    <input type="number" id="radius" value="5" step="1">
                </div>
                <div class="form-group" style="display: flex; flex-direction: column; justify-content: flex-end; gap: 10px;">
                    <button class="btn btn-success" onclick="getUserLocation()">
                        üì° Ma position
                    </button>
                    <button class="btn btn-primary" onclick="fetchNearbyPharmacies()">
                        üîç Rechercher
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messages"></div>

        <!-- Content -->
        <div class="content">
            <!-- Map -->
            <div class="map-container">
                <div class="section-title">üó∫Ô∏è Carte Interactive (Leaflet)</div>
                <div id="map"></div>
            </div>

            <!-- List -->
            <div class="list-container">
                <div class="section-title">
                    üìù Liste des pharmacies <span id="count">(0)</span>
                </div>
                <div id="pharmacyList" class="pharmacy-list"></div>
            </div>
        </div>

        <!-- Info technique -->
        <div class="info">
            <div class="info-title">üìä Informations techniques</div>
            <div id="techInfo"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const API_URL = 'http://localhost:8000/api';
        let map;
        let markers = [];
        let pharmacies = [];
        let selectedPharmacy = null;

        // Initialiser la carte
        function initMap() {
            map = L.map('map').setView([3.8480, 11.5021], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            console.log('‚úÖ Carte initialis√©e');
        }

        // Afficher les messages
        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const className = type === 'error' ? 'error' : 'loading';
            messagesDiv.innerHTML = `<div class="${className}">${message}</div>`;
            
            if (type === 'info') {
                setTimeout(() => messagesDiv.innerHTML = '', 3000);
            }
        }

        // Mettre √† jour les infos techniques
        function updateTechInfo(mode, data = {}) {
            const techInfo = document.getElementById('techInfo');
            techInfo.innerHTML = `
                ‚Ä¢ API URL: ${API_URL}<br>
                ‚Ä¢ Mode: ${mode}<br>
                ${data.position ? `‚Ä¢ Position: ${data.position}<br>` : ''}
                ${data.radius ? `‚Ä¢ Rayon: ${data.radius} km<br>` : ''}
                ‚Ä¢ Pharmacies trouv√©es: ${pharmacies.length}
            `;
        }

        // R√©cup√©rer toutes les pharmacies
        async function fetchAllPharmacies() {
            console.log('üîç R√©cup√©ration de toutes les pharmacies...');
            showMessage('‚è≥ Chargement des pharmacies...', 'info');
            
            try {
                const response = await fetch(`${API_URL}/pharmacies/`);
                console.log('üì° Statut r√©ponse:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Donn√©es re√ßues:', data);
                
                pharmacies = data;
                displayPharmacies();
                updateMap();
                updateTechInfo('Liste compl√®te');
                showMessage('', '');
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                showMessage(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        // Rechercher les pharmacies proches
        async function fetchNearbyPharmacies() {
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            const radius = document.getElementById('radius').value;
            
            console.log(`üîç Recherche proximit√©: lat=${lat}, lon=${lon}, radius=${radius}`);
            showMessage('‚è≥ Recherche en cours...', 'info');
            
            try {
                const url = `${API_URL}/pharmacies/nearby/?latitude=${lat}&longitude=${lon}&radius=${radius}`;
                const response = await fetch(url);
                console.log('üì° Statut r√©ponse:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Donn√©es re√ßues:', data);
                
                pharmacies = data.results || data;
                displayPharmacies();
                updateMap(parseFloat(lat), parseFloat(lon));
                updateTechInfo('Recherche par proximit√©', {
                    position: `${lat}, ${lon}`,
                    radius: radius
                });
                showMessage('', '');
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                showMessage(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        // Afficher les pharmacies dans la liste
        function displayPharmacies() {
            const listDiv = document.getElementById('pharmacyList');
            const countSpan = document.getElementById('count');
            
            countSpan.textContent = `(${pharmacies.length})`;
            
            if (pharmacies.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #a0aec0;">Aucune pharmacie trouv√©e</div>';
                return;
            }
            
            listDiv.innerHTML = pharmacies.map((pharmacy, index) => `
                <div class="pharmacy-card" id="card-${index}" onclick="selectPharmacy(${index})">
                    <div class="pharmacy-name">
                        <span>${pharmacy.name}</span>
                        ${pharmacy.distance !== null && pharmacy.distance !== undefined 
                            ? `<span class="distance-badge">${pharmacy.distance} km</span>` 
                            : ''}
                    </div>
                    <div class="pharmacy-info">üìç ${pharmacy.address}</div>
                    <div class="pharmacy-info">üìû ${pharmacy.phone}</div>
                    ${pharmacy.email ? `<div class="pharmacy-info">‚úâÔ∏è ${pharmacy.email}</div>` : ''}
                    <div class="pharmacy-info" style="color: #a0aec0; font-size: 0.85em;">
                        GPS: ${pharmacy.latitude}, ${pharmacy.longitude}
                    </div>
                    <span class="status-badge ${pharmacy.is_active ? 'status-active' : 'status-inactive'}">
                        ${pharmacy.is_active ? '‚úì Active' : '‚úó Inactive'}
                    </span>
                </div>
            `).join('');
        }

        // Mettre √† jour la carte
        function updateMap(userLat, userLon) {
            // Supprimer les anciens marqueurs
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            if (pharmacies.length === 0) return;
            
            // Ajouter les marqueurs des pharmacies
            pharmacies.forEach((pharmacy, index) => {
                const marker = L.marker([pharmacy.latitude, pharmacy.longitude])
                    .addTo(map)
                    .bindPopup(`
                        <div style="padding: 10px;">
                            <h3 style="margin: 0 0 10px 0; color: #667eea;">${pharmacy.name}</h3>
                            <p style="margin: 5px 0;"><strong>üìç</strong> ${pharmacy.address}</p>
                            <p style="margin: 5px 0;"><strong>üìû</strong> ${pharmacy.phone}</p>
                            ${pharmacy.distance !== null && pharmacy.distance !== undefined 
                                ? `<p style="margin: 5px 0; color: #667eea; font-weight: bold;">Distance: ${pharmacy.distance} km</p>` 
                                : ''}
                        </div>
                    `);
                
                marker.on('click', () => selectPharmacy(index));
                markers.push(marker);
            });
            
            // Ajouter un marqueur pour la position de l'utilisateur si recherche proximit√©
            if (userLat && userLon) {
                const userMarker = L.circleMarker([userLat, userLon], {
                    radius: 10,
                    fillColor: "#3b82f6",
                    color: "#ffffff",
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup("üìç Votre position");
                
                markers.push(userMarker);
            }
            
            // Ajuster la vue
            const bounds = L.latLngBounds(pharmacies.map(p => [p.latitude, p.longitude]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        // S√©lectionner une pharmacie
        function selectPharmacy(index) {
            // D√©s√©lectionner l'ancienne
            if (selectedPharmacy !== null) {
                const oldCard = document.getElementById(`card-${selectedPharmacy}`);
                if (oldCard) oldCard.classList.remove('selected');
            }
            
            // S√©lectionner la nouvelle
            selectedPharmacy = index;
            const card = document.getElementById(`card-${index}`);
            if (card) {
                card.classList.add('selected');
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            // Centrer la carte
            const pharmacy = pharmacies[index];
            map.setView([pharmacy.latitude, pharmacy.longitude], 15);
            markers[index].openPopup();
        }

        // Toggle formulaire de recherche
        function toggleSearchForm() {
            const form = document.getElementById('searchForm');
            form.classList.toggle('active');
        }

        // Obtenir la position GPS
        function getUserLocation() {
            if (!navigator.geolocation) {
                alert('‚ùå G√©olocalisation non support√©e par votre navigateur');
                return;
            }
            
            showMessage('üì° Obtention de votre position...', 'info');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    document.getElementById('latitude').value = lat.toFixed(4);
                    document.getElementById('longitude').value = lon.toFixed(4);
                    
                    map.setView([lat, lon], 13);
                    
                    showMessage(`‚úÖ Position d√©tect√©e: ${lat.toFixed(4)}, ${lon.toFixed(4)}`, 'info');
                },
                (error) => {
                    showMessage('‚ùå Impossible de r√©cup√©rer votre position', 'error');
                }
            );
        }

        // Initialisation au chargement
        window.onload = function() {
            console.log('üöÄ Initialisation de l\'application...');
            initMap();
            fetchAllPharmacies();
        };
    </script>
</body>
</html>
