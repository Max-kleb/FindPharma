<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FindPharma - Test API</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-4xl font-bold text-indigo-600 mb-2">
                üè• FindPharma - Test API
            </h1>
            <p class="text-gray-600">
                Interface de test pour les endpoints de l'API FindPharma
            </p>
        </div>

        <!-- Tabs Navigation -->
        <div class="bg-white rounded-lg shadow-lg mb-6">
            <div class="flex border-b">
                <button onclick="showTab('pharmacies')" id="tab-pharmacies" class="flex-1 py-4 px-6 text-center font-semibold bg-indigo-600 text-white">
                    üìç Toutes les Pharmacies
                </button>
                <button onclick="showTab('nearby')" id="tab-nearby" class="flex-1 py-4 px-6 text-center font-semibold text-gray-600 hover:bg-gray-100">
                    üîç Recherche √† Proximit√©
                </button>
                <button onclick="showTab('search')" id="tab-search" class="flex-1 py-4 px-6 text-center font-semibold text-gray-600 hover:bg-gray-100">
                    üíä Recherche M√©dicaments
                </button>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-6">
            <strong>Erreur:</strong> <span id="error-text"></span>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="hidden bg-white rounded-lg shadow-lg p-12 text-center">
            <div class="text-4xl mb-4">‚è≥</div>
            <p class="text-gray-600">Chargement des donn√©es...</p>
        </div>

        <!-- Content Area -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <!-- Tab: Toutes les Pharmacies -->
            <div id="content-pharmacies" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        Liste des Pharmacies
                    </h2>
                    <button onclick="loadAllPharmacies()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                        üîÑ Actualiser
                    </button>
                </div>
                <div id="pharmacies-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- Tab: Recherche Proximit√© -->
            <div id="content-nearby" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    Recherche de Pharmacies √† Proximit√©
                </h2>
                <form onsubmit="searchNearby(event)" class="bg-gray-50 p-6 rounded-lg mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Latitude</label>
                            <input type="number" step="any" id="latitude" value="3.8480" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Longitude</label>
                            <input type="number" step="any" id="longitude" value="11.5021"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rayon (km)</label>
                            <input type="number" step="0.1" id="radius" value="5"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold">
                        üîç Rechercher
                    </button>
                </form>
                <div id="nearby-results"></div>
            </div>

            <!-- Tab: Recherche M√©dicaments -->
            <div id="content-search" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    Recherche de M√©dicaments
                </h2>
                <form onsubmit="searchMedicines(event)" class="bg-gray-50 p-6 rounded-lg mb-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nom du m√©dicament</label>
                        <input type="text" id="search-query" placeholder="Ex: Parac√©tamol, Amoxicilline..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-semibold">
                        üîé Rechercher
                    </button>
                </form>
                <div id="search-results"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000/api';

        // Afficher un message dans la console
        console.log('FindPharma Test API - Chargement...');
        console.log('API URL:', API_URL);

        // Gestion des onglets
        function showTab(tabName) {
            // Cacher tous les contenus
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // R√©initialiser tous les boutons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('text-gray-600', 'hover:bg-gray-100');
            });

            // Activer l'onglet s√©lectionn√©
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('bg-indigo-600', 'text-white');
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-600', 'hover:bg-gray-100');

            // Charger les donn√©es si n√©cessaire
            if (tabName === 'pharmacies') {
                loadAllPharmacies();
            }
        }

        // Afficher/masquer le chargement
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.remove('hidden');
            } else {
                loading.classList.add('hidden');
            }
        }

        // Afficher les erreurs
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        // Cr√©er une carte de pharmacie
        function createPharmacyCard(pharmacy, showDistance = false) {
            const statusClass = pharmacy.is_open ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const statusText = pharmacy.is_open ? '‚úÖ Ouvert' : 'üî¥ Ferm√©';
            
            let distanceHtml = '';
            if (showDistance && pharmacy.distance) {
                distanceHtml = `<p class="font-semibold text-indigo-600">üìè ${pharmacy.distance.toFixed(2)} km</p>`;
            }

            let locationHtml = '';
            if (pharmacy.location && pharmacy.location.coordinates) {
                locationHtml = `<p class="text-xs text-gray-500">üó∫Ô∏è ${pharmacy.location.coordinates[1]}, ${pharmacy.location.coordinates[0]}</p>`;
            }

            return `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-lg transition-shadow">
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="font-bold text-lg text-gray-800">${pharmacy.name}</h3>
                        <span class="px-2 py-1 rounded text-xs font-semibold ${statusClass}">${statusText}</span>
                    </div>
                    <div class="space-y-2 text-sm text-gray-600">
                        <p>üìç ${pharmacy.address}</p>
                        <p>üìû ${pharmacy.phone}</p>
                        ${pharmacy.email ? `<p>‚úâÔ∏è ${pharmacy.email}</p>` : ''}
                        ${distanceHtml}
                        ${locationHtml}
                    </div>
                </div>
            `;
        }

        // Cr√©er une carte de m√©dicament
        function createMedicineCard(medicine) {
            let pharmaciesHtml = '';
            if (medicine.pharmacies && medicine.pharmacies.length > 0) {
                const pharmaciesList = medicine.pharmacies.map(p => {
                    let stockInfo = '';
                    if (p.stock) {
                        stockInfo = `<span class="ml-2 text-green-600">(${p.stock.quantity} en stock - ${p.stock.price} FCFA)</span>`;
                    }
                    return `<li class="text-xs text-gray-600">‚Ä¢ ${p.name}${stockInfo}</li>`;
                }).join('');

                pharmaciesHtml = `
                    <div class="mt-3 pt-3 border-t">
                        <p class="font-semibold text-gray-700 mb-2">Disponible dans ${medicine.pharmacies.length} pharmacie(s):</p>
                        <ul class="space-y-1">${pharmaciesList}</ul>
                    </div>
                `;
            }

            return `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-lg transition-shadow">
                    <h3 class="font-bold text-lg text-gray-800 mb-2">${medicine.name}</h3>
                    <div class="space-y-2 text-sm">
                        <div>
                            <span class="font-semibold text-gray-700">Cat√©gorie:</span>
                            <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">${medicine.category}</span>
                        </div>
                        ${medicine.description ? `<p class="text-gray-600">${medicine.description}</p>` : ''}
                        ${pharmaciesHtml}
                    </div>
                </div>
            `;
        }

        // Charger toutes les pharmacies
        async function loadAllPharmacies() {
            console.log('Chargement des pharmacies...');
            showLoading(true);
            const container = document.getElementById('pharmacies-list');
            
            try {
                console.log('Fetching:', `${API_URL}/pharmacies/`);
                const response = await fetch(`${API_URL}/pharmacies/`);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Donn√©es re√ßues:', data.length, 'pharmacies');
                
                if (data.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">Aucune pharmacie trouv√©e</div>';
                } else {
                    container.innerHTML = data.map(p => createPharmacyCard(p)).join('');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError(`${error.message}. V√©rifiez que le serveur Django est d√©marr√© sur http://localhost:8000`);
                container.innerHTML = `<div class="col-span-full text-center py-12 text-red-500">
                    <p class="font-bold mb-2">‚ùå Erreur de connexion</p>
                    <p>${error.message}</p>
                    <p class="mt-4 text-sm">Assurez-vous que le serveur Django est d√©marr√© :</p>
                    <code class="block mt-2 bg-gray-100 text-gray-800 p-2 rounded">python manage.py runserver</code>
                </div>`;
            } finally {
                showLoading(false);
            }
        }

        // Rechercher pharmacies √† proximit√©
        async function searchNearby(event) {
            event.preventDefault();
            showLoading(true);

            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            const radius = document.getElementById('radius').value;

            try {
                const response = await fetch(
                    `${API_URL}/pharmacies/nearby/?latitude=${latitude}&longitude=${longitude}&radius=${radius}`
                );
                if (!response.ok) throw new Error('Erreur lors de la recherche');
                const data = await response.json();
                
                const container = document.getElementById('nearby-results');
                if (data.length === 0) {
                    container.innerHTML = '<div class="text-center py-12 text-gray-500">Aucune pharmacie trouv√©e dans ce p√©rim√®tre</div>';
                } else {
                    container.innerHTML = `
                        <h3 class="text-xl font-semibold mb-4">R√©sultats (${data.length})</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${data.map(p => createPharmacyCard(p, true)).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        // Rechercher m√©dicaments
        async function searchMedicines(event) {
            event.preventDefault();
            showLoading(true);

            const query = document.getElementById('search-query').value.trim();
            if (!query) {
                showError('Veuillez entrer un nom de m√©dicament');
                showLoading(false);
                return;
            }

            try {
                const response = await fetch(`${API_URL}/search/?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('Erreur lors de la recherche');
                const data = await response.json();
                
                const container = document.getElementById('search-results');
                if (data.length === 0) {
                    container.innerHTML = `<div class="text-center py-12 text-gray-500">Aucun m√©dicament trouv√© pour "${query}"</div>`;
                } else {
                    container.innerHTML = `
                        <h3 class="text-xl font-semibold mb-4">R√©sultats (${data.length})</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${data.map(m => createMedicineCard(m)).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        // Charger les pharmacies au d√©marrage
        window.addEventListener('DOMContentLoaded', () => {
            loadAllPharmacies();
        });
    </script>
</body>
</html>
